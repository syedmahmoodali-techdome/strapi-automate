name: Deploy Strapi CMS (Dockerized)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  terraform:
    runs-on: ubuntu-latest
    outputs:
      app_service_name: ${{ steps.tfout.outputs.app_service_name }}
      resource_group_name: ${{ steps.tfout.outputs.resource_group_name }}
      azure_registry_name: ${{ steps.tfout.outputs.azure_registry_name }}
      azure_registry_login_server: ${{ steps.tfout.outputs.azure_registry_login_server }}

    steps:
      - name: Checkout infra repo
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update -y && sudo apt-get install -y jq

      - name: Generate terraform.tfvars.json
        run: |
          jq '{
            clinic_name: .clinic.name,
            clinic_environment: .clinic.environment,
            clinic_region: .clinic.region,
            strapi_repo: .strapi.repo,
            strapi_branch: .strapi.branch,
            strapi_repo_subdir: .strapi.repo_subdir,
            strapi_admin_email: .strapi.admin_email,
            strapi_admin_password: .strapi.admin_password,
            db_name: .database.name,
            db_username: .database.username,
            db_password: .database.password,
            azure_resource_group_prefix: .azure.resource_group_prefix,
            azure_app_service_plan_sku: .azure.app_service_plan_sku
          }' clinic-config.json > terraform.tfvars.json

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init & Apply
        env:
          ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
        run: |
          terraform init
          terraform apply -auto-approve -var-file="terraform.tfvars.json"

      - name: Capture Terraform Outputs
        id: tfout
        run: |
          echo "app_service_name=$(terraform output -raw app_service_name)" >> $GITHUB_OUTPUT
          echo "resource_group_name=$(terraform output -raw resource_group_name)" >> $GITHUB_OUTPUT
          echo "azure_registry_name=$(terraform output -raw azure_registry_name)" >> $GITHUB_OUTPUT
          echo "azure_registry_login_server=$(terraform output -raw azure_registry_login_server)" >> $GITHUB_OUTPUT

  deploy:
    needs: terraform
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout Strapi repo (read-only)
      - name: Checkout Strapi Source
        uses: actions/checkout@v4
        with:
          repository: techdome-io/ecommpoc
          token: ${{ secrets.GH_PAT }}
          path: ecommpoc

      # 2Ô∏è‚É£ Copy subdir for build
      - name: Copy Strapi Project
        run: |
          mkdir strapi-app
          cp -r ecommpoc/my-strapi-project/* strapi-app/

      # 3Ô∏è‚É£ Create Dockerfile dynamically (no change to repo)
      - name: Create Dockerfile
        working-directory: strapi-app
        run: |
          cat > Dockerfile <<'EOF'
          FROM node:18-alpine
          WORKDIR /app
          COPY package*.json ./
          RUN npm ci
          COPY . .
          RUN npm run build
          EXPOSE 1337
          CMD ["npm", "run", "start"]
          EOF

      # 4Ô∏è‚É£ Build Docker image locally
      - name: Build Docker image
        run: |
          docker build -t strapi-local:latest ./strapi-app

      # 5Ô∏è‚É£ Run the container locally to test
      - name: Run test container
        run: |
          docker run -d -p 1337:1337 --name strapi-test strapi-local:latest
          echo "Waiting for Strapi to start..."
          sleep 20
          curl -I http://localhost:1337 || (docker logs strapi-test && exit 1)
          docker stop strapi-test
          docker rm strapi-test

      # 6Ô∏è‚É£ Azure Login
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          auth-type: SERVICE_PRINCIPAL

      # 7Ô∏è‚É£ Get ACR credentials
      - name: Get ACR credentials
        id: acr
        run: |
          LOGIN_SERVER=${{ needs.terraform.outputs.azure_registry_login_server }}
          az acr login --name ${{ needs.terraform.outputs.azure_registry_name }}
          echo "login_server=$LOGIN_SERVER" >> $GITHUB_OUTPUT

      # 8Ô∏è‚É£ Tag and push image to ACR
      - name: Push image to ACR
        run: |
          LOGIN_SERVER=${{ needs.terraform.outputs.azure_registry_login_server }}
          docker tag strapi-local:latest $LOGIN_SERVER/strapi:${{ github.sha }}
          docker push $LOGIN_SERVER/strapi:${{ github.sha }}

      # 9Ô∏è‚É£ Configure App Service to use new image
      - name: Update App Service to use new image
        run: |
          az webapp config container set \
            --name "${{ needs.terraform.outputs.app_service_name }}" \
            --resource-group "${{ needs.terraform.outputs.resource_group_name }}" \
            --docker-custom-image-name "${{ needs.terraform.outputs.azure_registry_login_server }}/strapi:${{ github.sha }}" \
            --docker-registry-server-url "https://${{ needs.terraform.outputs.azure_registry_login_server }}"

      # üîü Verify deployment
      - name: Verify Strapi on Azure
        run: |
          echo "Waiting for Strapi on Azure..."
          for i in {1..15}; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://${{ needs.terraform.outputs.app_service_name }}.azurewebsites.net/admin || true)
            if [ "$STATUS" = "200" ]; then
              echo "‚úÖ Strapi is up!"
              exit 0
            fi
            echo "‚è≥ Waiting... ($i/15)"
            sleep 15
          done
          echo "‚ùå Strapi did not respond in time."
          exit 1
