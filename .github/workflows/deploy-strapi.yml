name: Deploy Strapi CMS

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  terraform:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout infra repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git to use PAT for private repos
        run: |
          git config --global url."https://${{ secrets.GH_PAT }}@github.com/".insteadOf "https://github.com/"

      - name: Install jq
        run: sudo apt-get update -y && sudo apt-get install -y jq

      - name: Build terraform.tfvars.json from clinic-config.json
        run: |
          jq '{
            clinic_name: .clinic.name,
            clinic_environment: .clinic.environment,
            clinic_region: .clinic.region,
            strapi_repo: .strapi.repo,
            strapi_branch: .strapi.branch,
            strapi_repo_subdir: .strapi.repo_subdir,
            strapi_admin_email: .strapi.admin_email,
            strapi_admin_password: .strapi.admin_password,
            db_name: .database.name,
            db_username: .database.username,
            db_password: .database.password,
            azure_resource_group_prefix: .azure.resource_group_prefix,
            azure_app_service_plan_sku: .azure.app_service_plan_sku,
            linked_storefront_url: .integration.linked_storefront_url,
            backend_url: .integration.backend_url,
            brand_primary_color: .clinic.branding.primary_color,
            brand_secondary_color: .clinic.branding.secondary_color,
            brand_logo_url: .clinic.branding.logo_url,
            brand_favicon_url: .clinic.branding.favicon_url
          }' clinic-config.json > terraform.tfvars.json
          echo "terraform.tfvars.json:"
          cat terraform.tfvars.json

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform init
        run: terraform init

      - name: Terraform apply
        env:
          ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          terraform apply -auto-approve \
            -var-file="terraform.tfvars.json" \
            -var="github_token=$GH_PAT"

      - name: Show outputs (json)
        run: terraform output -json

      - name: Export outputs
        id: tfout
        run: | 
          echo "app_service_name=$(terraform output -raw app_service_name)" >> $GITHUB_OUTPUT
          echo "resource_group_name=$(terraform output -raw resource_group_name)" >> $GITHUB_OUTPUT

  deploy:
    needs: terraform
    runs-on: ubuntu-latest

    steps:
      # ✅ Step 1: Checkout your company repo
      - name: Checkout company Strapi repo
        uses: actions/checkout@v4
        with:
          repository: techdome-io/ecommpoc
          token: ${{ secrets.GH_PAT }}
          path: ecommpoc

      # ✅ Step 2: Setup Node.js
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # ✅ Step 3: Install dependencies from inside the Strapi folder
      - name: Install Strapi dependencies
        working-directory: ecommpoc/my-strapi-project
        run: npm ci

      # ✅ Step 4: Build Strapi
      - name: Build Strapi admin
        working-directory: ecommpoc/my-strapi-project
        run: npm run build

      # ✅ Step 5: Login to Azure
      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.ARM_CLIENT_ID }}
          tenant-id: ${{ secrets.ARM_TENANT_ID }}
          subscription-id: ${{ secrets.ARM_SUBSCRIPTION_ID }}
          client-secret: ${{ secrets.ARM_CLIENT_SECRET }}
          auth-type: SERVICE_PRINCIPAL

      # ✅ Step 6: Deploy Strapi build to Azure App Service
      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v2
        with:
          app-name: ${{ needs.terraform.outputs.app_service_name }}
          package: ./ecommpoc/my-strapi-project
